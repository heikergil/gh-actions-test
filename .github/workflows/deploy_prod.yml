name: Prod build
on:
   workflow_dispatch:
     
jobs:
    build:
        timeout-minutes: 30 # nothing good happens after 30 minutes
        name: Shopify Prod Build
        runs-on: ubuntu-latest
        outputs:
          themeid: ${{ steps.theme_id.outputs.value }}
        steps:
            - uses: actions/checkout@v2
            - uses: ruby/setup-ruby@v1
            - name: Read .nvmrc
              run: echo ::set-output name=NODE_VERSION::$(cat .nvmrc)
              id: nvm
            - name: Use Node.js ${{ steps.nvm.outputs.NODE_VERSION }}
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ steps.nvm.outputs.NODE_VERSION }}
                  cache: 'npm'

            - name: Cache node_modules
              uses: actions/cache@v3
              id: cache-node-modules
              with:
                path: |
                  node_modules
                key: modules-${{ hashFiles('package-lock.json') }}

            - name: Install pakages
              if: steps.cache-node-modules.outputs.cache-hit != 'true'
              run: npm install

            - name: set-outputs
              run: echo ::set-output name=themeid::'Hello World'
            
         

    test:              
      name: E2E tests
      needs: build
      timeout-minutes: 30
      runs-on: ubuntu-latest
      # strategy:
      #   fail-fast: false
      #   matrix:
      #     shard: [1, 2, 3]
      steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3

      - name: Cache node_modules
        uses: actions/cache@v3
        with:
          path: |
            node_modules
          key: modules-${{ hashFiles('package-lock.json') }}
      
      - name: echo something
        run: echo Hello World


    deploy:
      name: publish shopify theme 
      needs: [build, test]
      timeout-minutes: 30
      runs-on: ubuntu-latest
      steps:
            - uses: actions/checkout@v2
            - uses: ruby/setup-ruby@v1

            - name: Cache node_modules
              uses: actions/cache@v3
              id: cache-node-modules
              with:
                path: |
                  node_modules
                key: modules-${{ hashFiles('package-lock.json') }}

            - name: echo something
              run: echo Hello World
            
